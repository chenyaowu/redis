# 基于Redis的分布式布隆过滤器

## 引出布隆过滤器

- 现有50亿个电话号码，现有10万个电话号码，要**快速准确**判断这些号码是否存在？
  1. 通过数据库查询：实现**快速**有点难
  2. 数据预放在集合中：50亿*8bit≈40GB（**内存**浪费或不够）
  3. hyperloglog:**准确**点难
- 垃圾邮件过滤
- 文字处理软件(例如word)错误单词检测
- 网络爬虫重复url检测
- HBase行过滤

## 布隆过滤器原理

- 实现原理：一个很长的二进制向量和若干个哈希函数
- 参数：m个二进制向量，n个预备数据，k个hash函数
- 构建布隆过滤器：n个预备数据走一遍上面流程
- 判断元素存在：走一遍上面过程：如果都是1，则表明存在，反之不存在

## 布隆过滤器误差率

- 肯定存在误差：恰好都命中了。
- 直观因素：m/n的比率，hash函数的个数
- 实际误差公式：
  1. 1个元素，1个hash函数，任意一个比特为1的概率为 $ \frac{1}{m}$，依然为0的概率为$1- \frac{1}{m}$
  2.  k个函数，依然为0的概率为$ （1-\frac{1}{m}）^k​$，n个元素，依然为0的概率为$ {_{(1-\frac{1}{m})}}^{nk}​$
  3. 被设置为1的概率为$1- {_{(1-\frac{1}{m})}}^{nk}​$
  4. 新元素全中的概率为$(1-{_{(1-\frac{1}{m})}}^{nk})^{k}$ ≈ $(1-e-\frac{kn}{m})^k$
- m/n与误差率成反比，k与误差率成反比



## 本地布隆过滤器

- 现有库:[guava](http://ifeve.com/google-guava-hashing/)
- 本地布隆过滤器的问题：
  1. 容量受限制
  2. 多个应用存在多个布隆过滤器，构建同步复杂

## 基于Redis布隆过滤器

![redis布隆过滤器](https://github.com/chenyaowu/redis/blob/master/image/RedisBloom1.jpg)

- 基于位图实现

  ![基于位图实现](https://github.com/chenyaowu/redis/blob/master/image/RedisBloom2.jpg)

  - 定义布隆过滤器构造函数:m、n、k、误差率
  - 定义布隆过滤器操作函数:add和contain
  - 封装Redis位图操作
  - 开发测试样例

## Redis单机布隆过滤器

- 问题：

  - 速度慢：比本地慢，输在网络
    - 解决：单独部署，与应用同机房设置机架部署
  - 容量受限：Redis最大字符串为512MB、Redis单机容量
    - 解决：基于Redis Cluster实现

  

## Redis分布式布隆过滤器

- 实现方法
  - 多个布隆过滤器：二次路由
  - 基于pipeline提高效率

